# Homebrew
if [ -x /home/linuxbrew/.linuxbrew/bin/brew ]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Completion setup
autoload -Uz compinit
compinit

# History configuration
HISTFILE="$HOME/.zsh_history"
HISTSIZE=10000
SAVEHIST=10000
setopt appendhistory hist_ignore_dups

# GitHub CLI completion
if command -v gh >/dev/null 2>&1; then
  eval "$(gh completion -s zsh)"
fi

# SSH keychain
if command -v keychain >/dev/null 2>&1 && [ -r "$HOME/.ssh/id_ed25519" ]; then
  /usr/bin/keychain -q --nogui "$HOME/.ssh/id_ed25519"
  [ -r "$HOME/.keychain/$HOST-sh" ] && source "$HOME/.keychain/$HOST-sh"
fi

# Local secrets and tool environments
[ -r "$HOME/.env.keys" ] && source "$HOME/.env.keys"

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
[ -r "$HOME/.deno/env" ] && . "$HOME/.deno/env"

# zellij https://github.com/zellij-org/zellij
#if [[ "$TERM_PROGRAM" == 'vscode' ]]; then
#  if [[ -z "$ZELLIJ" ]]; then
#    dir=$(git rev-parse --show-toplevel 2>/dev/null || printf '%s\n' "$PWD")
#    org="$(basename "$(dirname "$dir")")"
#    repo="$(basename "$dir")"
#
#    zellij attach --create $org-$repo
#    exit
#  fi
#else
#  if [[ -z "$VSCODE_RESOLVING_ENVIRONMENT" ]]; then
#    # export ZELLIJ_AUTO_ATTACH=true
#    export ZELLIJ_AUTO_EXIT=true
#    eval "$(zellij setup --generate-auto-start zsh)"
#  fi
#fi

# PATH and library path
typeset -U path
path=(
  "$HOME/.duckdb/cli/latest"
  "$HOME/bin"
  "$HOME/.risc0/bin"
  /usr/local/cuda/bin
  "$HOME/.local/bin"
  $path
)
export PATH
export LD_LIBRARY_PATH="/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"

# ls colors
if command -v dircolors >/dev/null 2>&1; then
  eval "$(dircolors -b)"
fi
alias ls='ls --color=auto'
alias ll='ls -lah'
alias claude-glm='ANTHROPIC_AUTH_TOKEN="{{ onepasswordRead  "op://Linux/glm/claude" }}" \
    ANTHROPIC_BASE_URL="https://api.z.ai/api/anthropic" \
    API_TIMEOUT_MS="3000000" \
CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1 \
ANTHROPIC_DEFAULT_HAIKU_MODEL="glm-4.5-air" \
ANTHROPIC_DEFAULT_SONNET_MODEL="glm-4.7" \
ANTHROPIC_DEFAULT_OPUS_MODEL="glm-5" claude'

# Prompt with git branch/state
autoload -Uz vcs_info
autoload -Uz add-zsh-hook
zstyle ':vcs_info:*' enable git
zstyle ':vcs_info:*' use-prompt-escapes true
zstyle ':vcs_info:git:*' actionformats '(%F{cyan}%b%f|%F{yellow}%a%f%F{red}%u%f%F{green}%c%f)'
zstyle ':vcs_info:git:*' check-for-changes true
zstyle ':vcs_info:git:*' unstagedstr '*'
zstyle ':vcs_info:git:*' stagedstr '+'
zstyle ':vcs_info:git:*' formats '(%F{cyan}%b%f%F{red}%u%f%F{green}%c%f)'

add-zsh-hook precmd vcs_info
setopt prompt_subst
PROMPT='%n@%m:%~ ${vcs_info_msg_0_}%# '

# ghq
function ghq-fzf() {
  local src=$(ghq list | fzf --preview "bat --color=always --style=header,grid --line-range :80 $(ghq root)/{}/README.*")
  if [ -n "$src" ]; then
    BUFFER="cd $(ghq root)/$src"
    zle accept-line
  fi
  zle -R -c
}
zle -N ghq-fzf
bindkey '^g' ghq-fzf

fzf-history-widget() {
  local selected

  # fc -rl 1
  #   - 履歴を新しい順（reverse）に取得します
  #   - 行頭に履歴番号が付きます
  selected=$(fc -rl 1 \
    | sed 's/^[[:space:]]*[0-9]\+[[:space:]]*//' \
    | fzf --tac +s) || return
    # 履歴番号を削除します
    # fzf でインタラクティブに検索します
    # --tac : 表示を逆順（最近の履歴を下側に）
    # +s    : 入力順ソートを維持します

  # 選択したコマンドをカーソル位置に挿入します
  LBUFFER+="$selected"
}

# zle widget として登録します
zle -N fzf-history-widget

# Ctrl-r に割り当てます
bindkey '^R' fzf-history-widget